<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="The rustc Query System: Query Definitions and Modifiers"><title>rustc_middle::query - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../static.files/rustdoc-865d4876.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="rustc_middle" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0-dev" data-channel="nightly" data-search-js="search-649a623e.js" data-stringdex-js="stringdex-910ef755.js" data-settings-js="settings-c38705f0.js" ><script src="../../static.files/storage-1b37d467.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../static.files/main-0ec66560.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-32bb7600.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-044be391.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">Module query</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../../rustc_middle/index.html"><img class="rust-logo" src="../../static.files/rust-logo-9a9549ea.svg" alt="logo"></a><h2><a href="../../rustc_middle/index.html">rustc_<wbr>middle</a><span class="version">1.91.0-dev</span></h2></div><div class="sidebar-elems"><section id="rustdoc-toc"><h2 class="location"><a href="#">Module query</a></h2><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#the-rustc-query-system-query-definitions-and-modifiers" title="The rustc Query System: Query Definitions and Modifiers">The rustc Query System: Query Definitions and Modifiers</a><ul><li><a href="#how-to-read-this-module" title="How to Read This Module">How to Read This Module</a></li><li><a href="#query-modifiers" title="Query Modifiers">Query Modifiers</a></li><li><a href="#query-expansion-and-code-generation" title="Query Expansion and Code Generation">Query Expansion and Code Generation</a></li></ul></li></ul><h3><a href="#reexports">Module Items</a></h3><ul class="block"><li><a href="#reexports" title="Re-exports">Re-exports</a></li><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#macros" title="Macros">Macros</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#traits" title="Traits">Traits</a></li></ul></section><div id="rustdoc-modnav"><h2 class="in-crate"><a href="../index.html">In crate rustc_<wbr>middle</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../index.html">rustc_middle</a></div><h1>Module <span>query</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/rustc_middle/query/mod.rs.html#1-2686">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="the-rustc-query-system-query-definitions-and-modifiers"><a class="doc-anchor" href="#the-rustc-query-system-query-definitions-and-modifiers">§</a>The rustc Query System: Query Definitions and Modifiers</h2>
<p>The core processes in rustc are shipped as queries. Each query is a demand-driven function from some key to a value.
The execution result of the function is cached and directly read during the next request, thereby improving compilation efficiency.
Some results are saved locally and directly read during the next compilation, which are core of incremental compilation.</p>
<h3 id="how-to-read-this-module"><a class="doc-anchor" href="#how-to-read-this-module">§</a>How to Read This Module</h3>
<p>Each <code>query</code> block in this file defines a single query, specifying its key and value types, along with various modifiers.
These query definitions are processed by the <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_macros/index.html"><code>rustc_macros</code></a>, which expands them into the necessary boilerplate code
for the query system—including the <a href="struct.Providers.html" title="struct rustc_middle::query::Providers"><code>Providers</code></a> struct (a function table for all query implementations, where each field is
a function pointer to the actual provider), caching, and dependency graph integration.
<strong>Note:</strong> The <code>Providers</code> struct is not a Rust trait, but a struct generated by the <code>rustc_macros</code> to hold all provider functions.
The <code>rustc_macros</code> also supports a set of <strong>query modifiers</strong> (see below) that control the behavior of each query.</p>
<p>The actual provider functions are implemented in various modules and registered into the <code>Providers</code> struct
during compiler initialization (see <a href="../../rustc_interface/passes/static.DEFAULT_QUERY_PROVIDERS.html"><code>rustc_interface::passes::DEFAULT_QUERY_PROVIDERS</code></a>).</p>
<h3 id="query-modifiers"><a class="doc-anchor" href="#query-modifiers">§</a>Query Modifiers</h3>
<p>Query modifiers are special flags that alter the behavior of a query. They are parsed and processed by the <code>rustc_macros</code>
The main modifiers are:</p>
<ul>
<li><code>desc { ... }</code>: Sets the human-readable description for diagnostics and profiling. Required for every query.</li>
<li><code>arena_cache</code>: Use an arena for in-memory caching of the query result.</li>
<li><code>cache_on_disk_if { ... }</code>: Cache the query result to disk if the provided block evaluates to true.</li>
<li><code>fatal_cycle</code>: If a dependency cycle is detected, abort compilation with a fatal error.</li>
<li><code>cycle_delay_bug</code>: If a dependency cycle is detected, emit a delayed bug instead of aborting immediately.</li>
<li><code>cycle_stash</code>: If a dependency cycle is detected, stash the error for later handling.</li>
<li><code>no_hash</code>: Do not hash the query result for incremental compilation; just mark as dirty if recomputed.</li>
<li><code>anon</code>: Make the query anonymous in the dependency graph (no dep node is created).</li>
<li><code>eval_always</code>: Always evaluate the query, ignoring its dependencies and cached results.</li>
<li><code>depth_limit</code>: Impose a recursion depth limit on the query to prevent stack overflows.</li>
<li><code>separate_provide_extern</code>: Use separate provider functions for local and external crates.</li>
<li><code>feedable</code>: Allow the query result to be set from another query (“fed” externally).</li>
<li><code>return_result_from_ensure_ok</code>: When called via <code>tcx.ensure_ok()</code>, return <code>Result&lt;(), ErrorGuaranteed&gt;</code> instead of <code>()</code>.
If the query needs to be executed and returns an error, the error is returned to the caller.
Only valid for queries returning <code>Result&lt;_, ErrorGuaranteed&gt;</code>.</li>
</ul>
<p>For the up-to-date list, see the <code>QueryModifiers</code> struct in
<a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_macros/src/query.rs"><code>rustc_macros/src/query.rs</code></a>
and for more details in incremental compilation, see the
<a href="https://rustc-dev-guide.rust-lang.org/queries/incremental-compilation-in-detail.html#query-modifiers">Query modifiers in incremental compilation</a> section of the rustc-dev-guide.</p>
<h3 id="query-expansion-and-code-generation"><a class="doc-anchor" href="#query-expansion-and-code-generation">§</a>Query Expansion and Code Generation</h3>
<p>The <a href="../../rustc_macros/macro.rustc_queries.html"><code>rustc_macros::rustc_queries</code></a> macro expands each query definition into:</p>
<ul>
<li>A method on <a href="../ty/struct.TyCtxt.html" title="struct rustc_middle::ty::TyCtxt"><code>TyCtxt</code></a> (and <a href="plumbing/struct.TyCtxtAt.html" title="struct rustc_middle::query::plumbing::TyCtxtAt"><code>TyCtxtAt</code></a>) for invoking the query.</li>
<li>Provider traits and structs for supplying the query’s value.</li>
<li>Caching and dependency graph integration.</li>
<li>Support for incremental compilation, disk caching, and arena allocation as controlled by the modifiers.</li>
</ul>
<p>The macro-based approach allows the query system to be highly flexible and maintainable, while minimizing boilerplate.</p>
<p>For more details, see the <a href="https://rustc-dev-guide.rust-lang.org/query.html">rustc-dev-guide</a>.</p>
</div></details><h2 id="reexports" class="section-header">Re-exports<a href="#reexports" class="anchor">§</a></h2><dl class="item-table reexports"><dt id="reexport.IntoQueryParam"><code>pub use plumbing::<a class="trait" href="plumbing/trait.IntoQueryParam.html" title="trait rustc_middle::query::plumbing::IntoQueryParam">IntoQueryParam</a>;</code></dt><dt id="reexport.TyCtxtAt"><code>pub use plumbing::<a class="struct" href="plumbing/struct.TyCtxtAt.html" title="struct rustc_middle::query::plumbing::TyCtxtAt">TyCtxtAt</a>;</code></dt><dt id="reexport.TyCtxtEnsureDone"><code>pub use plumbing::<a class="struct" href="plumbing/struct.TyCtxtEnsureDone.html" title="struct rustc_middle::query::plumbing::TyCtxtEnsureDone">TyCtxtEnsureDone</a>;</code></dt><dt id="reexport.TyCtxtEnsureOk"><code>pub use plumbing::<a class="struct" href="plumbing/struct.TyCtxtEnsureOk.html" title="struct rustc_middle::query::plumbing::TyCtxtEnsureOk">TyCtxtEnsureOk</a>;</code></dt></dl><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><dl class="item-table"><dt><a class="mod" href="arena_cached/index.html" title="mod rustc_middle::query::arena_cached">arena_<wbr>cached</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dt><a class="mod" href="cached/index.html" title="mod rustc_middle::query::cached">cached</a></dt><dt><a class="mod" href="descs/index.html" title="mod rustc_middle::query::descs">descs</a></dt><dt><a class="mod" href="erase/index.html" title="mod rustc_middle::query::erase">erase</a></dt><dt><a class="mod" href="keys/index.html" title="mod rustc_middle::query::keys">keys</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt><dd>Defines the set of legal keys that can be used in queries.</dd><dt><a class="mod" href="on_disk_cache/index.html" title="mod rustc_middle::query::on_disk_cache">on_<wbr>disk_<wbr>cache</a></dt><dt><a class="mod" href="plumbing/index.html" title="mod rustc_middle::query::plumbing">plumbing</a></dt><dt><a class="mod" href="queries/index.html" title="mod rustc_middle::query::queries">queries</a></dt></dl><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">§</a></h2><dl class="item-table"><dt><a class="macro" href="macro.rustc_feedable_queries.html" title="macro rustc_middle::query::rustc_feedable_queries">rustc_<wbr>feedable_<wbr>queries</a><span title="Restricted Visibility">&nbsp;🔒</span> </dt></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.DynamicQueries.html" title="struct rustc_middle::query::DynamicQueries">Dynamic<wbr>Queries</a></dt><dt><a class="struct" href="struct.ExternProviders.html" title="struct rustc_middle::query::ExternProviders">Extern<wbr>Providers</a></dt><dt><a class="struct" href="struct.LocalCrate.html" title="struct rustc_middle::query::LocalCrate">Local<wbr>Crate</a></dt><dd>Placeholder for <code>CrateNum</code>’s “local” counterpart</dd><dt><a class="struct" href="struct.Providers.html" title="struct rustc_middle::query::Providers">Providers</a></dt><dt><a class="struct" href="struct.QueryArenas.html" title="struct rustc_middle::query::QueryArenas">Query<wbr>Arenas</a></dt><dt><a class="struct" href="struct.QueryCaches.html" title="struct rustc_middle::query::QueryCaches">Query<wbr>Caches</a></dt><dt><a class="struct" href="struct.QueryEngine.html" title="struct rustc_middle::query::QueryEngine">Query<wbr>Engine</a></dt><dt><a class="struct" href="struct.QueryStates.html" title="struct rustc_middle::query::QueryStates">Query<wbr>States</a></dt></dl><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2><dl class="item-table"><dt><a class="trait" href="trait.AsLocalKey.html" title="trait rustc_middle::query::AsLocalKey">AsLocal<wbr>Key</a></dt><dt><a class="trait" href="trait.Key.html" title="trait rustc_middle::query::Key">Key</a></dt><dd>The <code>Key</code> trait controls what types can legally be used as the key
for a query.</dd></dl></section></div></main></body></html>