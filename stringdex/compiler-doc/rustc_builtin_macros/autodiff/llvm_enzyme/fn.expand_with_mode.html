<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="We expand the autodiff macro to generate a new placeholder function which passes type-checking and can be called by users. The function body of the placeholder function will later be replaced on LLVM-IR level, so the design of the body is less important and for now should just prevent early inlining and optimizations which alter the function signature. The exact signature of the generated function depends on the configuration provided by the user, but here is an example:"><title>expand_with_mode in rustc_builtin_macros::autodiff::llvm_enzyme - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../../../static.files/rustdoc-528d32ef.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="rustc_builtin_macros" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0-dev" data-channel="nightly" data-search-js="search-e93015a6.js" data-stringdex-js="stringdex-0e748618.js" data-settings-js="settings-c38705f0.js" ><script src="../../../static.files/storage-1b37d467.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../static.files/main-c7770cbf.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-32bb7600.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-044be391.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">expand_with_mode</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../../../rustc_builtin_macros/index.html"><img class="rust-logo" src="../../../static.files/rust-logo-9a9549ea.svg" alt="logo"></a><h2><a href="../../../rustc_builtin_macros/index.html">rustc_<wbr>builtin_<wbr>macros</a><span class="version">1.91.0-dev</span></h2></div><div class="sidebar-elems"><div id="rustdoc-modnav"><h2><a href="index.html">In rustc_<wbr>builtin_<wbr>macros::<wbr>autodiff::<wbr>llvm_<wbr>enzyme</a></h2></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><div class="rustdoc-breadcrumbs"><a href="../../index.html">rustc_builtin_macros</a>::<wbr><a href="../index.html">autodiff</a>::<wbr><a href="index.html">llvm_enzyme</a></div><h1>Function <span class="fn">expand_<wbr>with_<wbr>mode</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../../src/rustc_builtin_macros/autodiff.rs.html#214-467">Source</a> </span></div><pre class="rust item-decl"><code>pub(crate) fn expand_with_mode(
    ecx: &amp;mut <a class="struct" href="../../../rustc_expand/base/struct.ExtCtxt.html" title="struct rustc_expand::base::ExtCtxt">ExtCtxt</a>&lt;'_&gt;,
    expand_span: <a class="struct" href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_span/span_encoding/struct.Span.html" title="struct rustc_span::span_encoding::Span">Span</a>,
    meta_item: &amp;<a class="struct" href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/ast/struct.MetaItem.html" title="struct rustc_ast::ast::MetaItem">MetaItem</a>,
    item: <a class="enum" href="../../../rustc_expand/base/enum.Annotatable.html" title="enum rustc_expand::base::Annotatable">Annotatable</a>,
    mode: <a class="enum" href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/expand/autodiff_attrs/enum.DiffMode.html" title="enum rustc_ast::expand::autodiff_attrs::DiffMode">DiffMode</a>,
) -&gt; <a class="struct" href="https://doc.rust-lang.org/nightly/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="enum" href="../../../rustc_expand/base/enum.Annotatable.html" title="enum rustc_expand::base::Annotatable">Annotatable</a>&gt;</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>We expand the autodiff macro to generate a new placeholder function which passes
type-checking and can be called by users. The function body of the placeholder function will
later be replaced on LLVM-IR level, so the design of the body is less important and for now
should just prevent early inlining and optimizations which alter the function signature.
The exact signature of the generated function depends on the configuration provided by the
user, but here is an example:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[autodiff(cos_box, Reverse, Duplicated, Active)]
</span><span class="kw">fn </span>sin(x: <span class="kw-2">&amp;</span>Box&lt;f32&gt;) -&gt; f32 {
    f32::sin(<span class="kw-2">**</span>x)
}</code></pre></div>
<p>which becomes expanded to:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[rustc_autodiff]
#[inline(never)]
</span><span class="kw">fn </span>sin(x: <span class="kw-2">&amp;</span>Box&lt;f32&gt;) -&gt; f32 {
    f32::sin(<span class="kw-2">**</span>x)
}
<span class="attr">#[rustc_autodiff(Reverse, Duplicated, Active)]
#[inline(never)]
</span><span class="kw">fn </span>cos_box(x: <span class="kw-2">&amp;</span>Box&lt;f32&gt;, dx: <span class="kw-2">&amp;mut </span>Box&lt;f32&gt;, dret: f32) -&gt; f32 {
    <span class="kw">unsafe </span>{
        <span class="macro">asm!</span>(<span class="string">"NOP"</span>);
    };
    ::core::hint::black_box(sin(x));
    ::core::hint::black_box((dx, dret));
    ::core::hint::black_box(sin(x))
}</code></pre></div>
<p>FIXME(ZuseZ4): Once autodiff is enabled by default, make this a doc comment which is checked
in CI.</p>
</div></details></section></div></main></body></html>