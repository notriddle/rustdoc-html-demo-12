<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Syncing changes between Clippy and rust-lang/rust - Clippy Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../../css/variables-3865ffda.css">
        <link rel="stylesheet" href="../../css/general-4c35105a.css">
        <link rel="stylesheet" href="../../css/chrome-c0e702bf.css">
        <link rel="stylesheet" href="../../css/print-ad67d350.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome-799aeb25.css">
        <link rel="stylesheet" href="../../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight-493f70e1.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight-56612340.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex-72365250.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc-eeee08c3.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Clippy Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-clippy/tree/master/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/rust-clippy/edit/master/book/src/development/infrastructure/sync.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="syncing-changes-between-clippy-and-rust-langrust"><a class="header" href="#syncing-changes-between-clippy-and-rust-langrust">Syncing changes between Clippy and <a href="https://github.com/rust-lang/rust"><code>rust-lang/rust</code></a></a></h1>
<p>Clippy currently gets built with a pinned nightly version.</p>
<p>In the <code>rust-lang/rust</code> repository, where rustc resides, there's a copy of
Clippy that compiler hackers modify from time to time to adapt to changes in the
unstable API of the compiler.</p>
<p>We need to sync these changes back to this repository periodically, and the
changes made to this repository in the meantime also need to be synced to the
<code>rust-lang/rust</code> repository.</p>
<p>To avoid flooding the <code>rust-lang/rust</code> PR queue, this two-way sync process is
done in a bi-weekly basis if there's no urgent changes. This is done starting on
the day of the Rust stable release and then every other week. That way we
guarantee that we keep this repo up to date with the latest compiler API, and
every feature in Clippy is available for 2 weeks in nightly, before it can get
to beta. For reference, the first sync following this cadence was performed the
2020-08-27.</p>
<p>This process is described in detail in the following sections. For general
information about <code>subtree</code>s in the Rust repository see <a href="https://rustc-dev-guide.rust-lang.org/external-repos.html#external-dependencies-subtree">the rustc-dev-guide</a>.</p>
<h2 id="patching-git-subtree-to-work-with-big-repos"><a class="header" href="#patching-git-subtree-to-work-with-big-repos">Patching git-subtree to work with big repos</a></h2>
<p>Currently, there's a bug in <code>git-subtree</code> that prevents it from working properly
with the <a href="https://github.com/rust-lang/rust"><code>rust-lang/rust</code></a> repo. There's an open PR to fix that, but it's
stale. Before continuing with the following steps, we need to manually apply
that fix to our local copy of <code>git-subtree</code>.</p>
<p>You can get the patched version of <code>git-subtree</code> from <a href="https://github.com/gitgitgadget/git/pull/493">here</a>.
Put this file under <code>/usr/lib/git-core</code> (making a backup of the previous file)
and make sure it has the proper permissions:</p>
<pre><code class="language-bash">sudo cp --backup /path/to/patched/git-subtree.sh /usr/lib/git-core/git-subtree
sudo chmod --reference=/usr/lib/git-core/git-subtree~ /usr/lib/git-core/git-subtree
sudo chown --reference=/usr/lib/git-core/git-subtree~ /usr/lib/git-core/git-subtree
</code></pre>
<blockquote>
<p><em>Note:</em> The first time running <code>git subtree push</code> a cache has to be built.
This involves going through the complete Clippy history once. For this you
have to increase the stack limit though, which you can do with <code>ulimit -s 60000</code>. Make sure to run the <code>ulimit</code> command from the same session you call
git subtree.</p>
</blockquote>
<blockquote>
<p><em>Note:</em> If you are a Debian user, <code>dash</code> is the shell used by default for
scripts instead of <code>sh</code>. This shell has a hardcoded recursion limit set to
1,000. In order to make this process work, you need to force the script to run
<code>bash</code> instead. You can do this by editing the first line of the <code>git-subtree</code>
script and changing <code>sh</code> to <code>bash</code>.</p>
</blockquote>
<blockquote>
<p>Note: The following sections assume that you have set up remotes following the
instructions in <a href="release.html#defining-remotes">defining remotes</a>.</p>
</blockquote>
<h2 id="performing-the-sync-from-rust-langrust-to-clippy"><a class="header" href="#performing-the-sync-from-rust-langrust-to-clippy">Performing the sync from <a href="https://github.com/rust-lang/rust"><code>rust-lang/rust</code></a> to Clippy</a></h2>
<p>Here is a TL;DR version of the sync process (all the following commands have
to be run inside the <code>rust</code> directory):</p>
<ol>
<li>
<p>Clone the <a href="https://github.com/rust-lang/rust"><code>rust-lang/rust</code></a> repository or make sure it is up-to-date.</p>
</li>
<li>
<p>Checkout the commit from the latest available nightly. You can get it using
<code>rustup check</code>.</p>
</li>
<li>
<p>Sync the changes to the rust-copy of Clippy to your Clippy fork:</p>
<pre><code class="language-bash"># Be sure to either use a net-new branch, e.g. `rustup`, or delete the branch beforehand
# because changes cannot be fast forwarded and you have to run this command again.
git subtree push -P src/tools/clippy clippy-local rustup
</code></pre>
<blockquote>
<p><em>Note:</em> Most of the time you have to create a merge commit in the
<code>rust-clippy</code> repo (this has to be done in the Clippy repo, not in the
rust-copy of Clippy):</p>
</blockquote>
<pre><code class="language-bash">git fetch upstream  # assuming upstream is the rust-lang/rust remote
git switch rustup
git merge upstream/master --no-ff
</code></pre>
<blockquote>
<p>Note: This is one of the few instances where a merge commit is allowed in
a PR.</p>
</blockquote>
</li>
<li>
<p>Bump the nightly version in the Clippy repository by running these commands:</p>
<pre><code class="language-bash">cargo dev sync update_nightly
git commit -m "Bump nightly version -&gt; YYYY-MM-DD" rust-toolchain.toml clippy_utils/README.md
</code></pre>
</li>
<li>
<p>Open a PR to <code>rust-lang/rust-clippy</code> and wait for it to get merged (to
accelerate the process ping the <code>@rust-lang/clippy</code> team in your PR and/or
ask them in the <a href="https://rust-lang.zulipchat.com/#narrow/stream/clippy">Zulip</a> stream.)</p>
</li>
</ol>
<h2 id="performing-the-sync-from-clippy-to-rust-langrust"><a class="header" href="#performing-the-sync-from-clippy-to-rust-langrust">Performing the sync from Clippy to <a href="https://github.com/rust-lang/rust"><code>rust-lang/rust</code></a></a></h2>
<p>All the following commands have to be run inside the <code>rust</code> directory.</p>
<ol>
<li>Make sure you have checked out the latest <code>master</code> of <code>rust-lang/rust</code>.</li>
<li>Sync the <code>rust-lang/rust-clippy</code> master to the rust-copy of Clippy:
<pre><code class="language-bash">git switch -c clippy-subtree-update
git subtree pull -P src/tools/clippy clippy-upstream master
</code></pre>
</li>
<li>Open a PR to <a href="https://github.com/rust-lang/rust"><code>rust-lang/rust</code></a></li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../development/infrastructure/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../development/infrastructure/backport.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../development/infrastructure/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../development/infrastructure/backport.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../ace-2a3cd908.js"></script>
        <script src="../../mode-rust-2c9d5c9a.js"></script>
        <script src="../../editor-16ca416c.js"></script>
        <script src="../../theme-dawn-4493f9c8.js"></script>
        <script src="../../theme-tomorrow_night-9dbe62a9.js"></script>

        <script src="../../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../../mark-09e88c2c.min.js"></script>
        <script src="../../searcher-9aeb6ddf.js"></script>

        <script src="../../clipboard-1626706a.min.js"></script>
        <script src="../../highlight-abc7f01d.js"></script>
        <script src="../../book-9576a2db.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
